{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <title>Student Dashboard - Padhal Mitra</title>
  </head>

  <body class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="w-full">
      <div
        class="max-w-6xl mx-auto flex items-center px-6 sm:px-8 lg:px-12 gap-6 sm:gap-8 lg:gap-12"
      >
        <!-- Logo -->
        <img
          src="{% static 'images/logo.png' %}"
          alt="logo"
          class="w-32 h-32 object-contain"
        />
      </div>
    </header>

    <!-- Main Section -->
    <section
      class="bg-white w-full px-6 py-8 md:py-12 rounded-lg mx-auto max-w-7xl"
    >
      <div class="bg-white p-8 rounded-lg w-full">
        <div class="grid grid-cols-3 gap-8 mb-8">
          <!-- Back link aligned to the left -->
          <h2
            class="sm:text-2xl md:text-3xl font-bold text-gray-800 pt-0 pl-4 md:pl-16 lg:pl-48 flex items-start gap-2"
          >
            <a
              href="{% url 'dashboard_student'%}"
              class="text-dark-900 hover:text-blue-500 font-semibold"
              >Back</a
            >
          </h2>

          <!-- Make Notes section in the middle -->
          <div class="text-blue-900 font-bold text-lg text-center">
            <span>Make Notes</span>
            <div class="mt-2">
              <a
                title="Microphone"
                href="#"
                class="text-white w-32 h-32 rounded-full shadow-2xl flex items-center justify-center border-4 border-white z-20 hover:opacity-90 transition"
                style="
                  background: linear-gradient(
                    to bottom,
                    #003366 0%,
                    #0066cc 100%
                  );
                "
              >
                <i class="fas fa-microphone text-3xl" alt="Microphone"></i>
              </a>
            </div>
          </div>

          <!-- Right Column (empty or add something later) -->
          <div></div>
        </div>
      </div>

      <!-- Note Form -->
      <form
        method="POST"
        action="#"
        class="w-full sm:w-[18rem] md:w-[20rem] lg:w-[20rem]"
      >
        {% csrf_token %}
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700" for="subject"
            >Subject Name</label
          >
          <input
            type="text"
            name="subject"
            id="subject"
            title="Subject Name"
            placeholder="Enter Subject Name"
            class="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
            required
          />
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700" for="title"
            >Title</label
          >
          <input
            type="text"
            name="title"
            id="title"
            title="title"
            placeholder="Enter Title"
            class="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
            required
          />
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700" for="note"
            >Note</label
          >
          <textarea
            name="note"
            id="note"
            title="Note"
            placeholder="Enter Note"
            rows="4"
            class="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
            required
          ></textarea>
        </div>

        <div class="flex justify-center gap-x-6">
          <button
            type="button"
            class="bg-blue-500 text-white py-3 px-8 rounded-md hover:bg-blue-400 w-full shadow-lg transition duration-300"
          >
            Read Out Loud
          </button>
          <button
            type="submit"
            class="bg-yellow-500 text-white py-3 px-8 rounded-md hover:bg-yellow-400 w-full shadow-lg transition duration-300"
          >
            Save
          </button>
        </div>
      </form>
    </section>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;
      
      document.addEventListener("keydown", async function (e) {
          if (e.code === "Space" && !isRecording) {
              try {
                  isRecording = true;
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  mediaRecorder = new MediaRecorder(stream);
      
                  mediaRecorder.ondataavailable = (e) => {
                      audioChunks.push(e.data);
                  };
      
                  mediaRecorder.onstop = async () => {
                      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                      const formData = new FormData();
                      formData.append('audio_file', audioBlob, 'recording.wav');
      
                      // Upload the audio file to the server
                      fetch('/save_note_audio/', {
                          method: 'POST',
                          headers: {
                              'X-CSRFToken': getCSRFToken() // Ensure CSRF protection
                          },
                          body: formData
                      })
                      .then(res => res.json())
                      .then(data => {
                          console.log("Upload response:", data);
      
                          // Check if the response contains a 'redirect' key
                          if (data.redirect) {
                              // If there's a redirect URL, navigate to it
                              window.location.href = data.redirect;
                          } else {
                              // Fallback to audio playback (if there's no redirect)
                              if (document.getElementById("audioPlayback")) {
                                  const audioUrl = URL.createObjectURL(audioBlob);
                                  document.getElementById("audioPlayback").src = audioUrl;
                              }
                          }
                      })
                      .catch(err => console.error("Upload error:", err));
      
                      audioChunks = [];
                  };
      
                  mediaRecorder.start();
                  console.log("Recording started...");
              } catch (err) {
                  console.error("Error accessing microphone:", err);
                  alert("Failed to access microphone. Please check permissions.");
              }
          }
      });
      
      document.addEventListener("keyup", function (e) {
          if (e.code === "Space" && isRecording) {
              mediaRecorder.stop();
              isRecording = false;
              console.log("Recording stopped.");
          }
      });
      
      // Helper to get CSRF token
      function getCSRFToken() {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
              if (cookie.trim().startsWith('csrftoken=')) {
                  return cookie.trim().substring('csrftoken='.length);
              }
          }
          return '';
      }
      </script> 
    
    
    
      

  
      
  </body>
</html>
